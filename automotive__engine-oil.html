<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Search Assortment — automotive / engine_oil</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Fonts: Proxima Nova if installed, else Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- DataTables + Buttons -->
  <link rel="stylesheet" href="https://cdn.datatables.net/v/bs5/dt-2.0.3/b-3.0.1/fh-4.0.1/r-3.0.1/datatables.min.css"/>

  <style>
    :root {
      --bg: #0f1220;
      --card: #141a2a;
      --card-2: #181e31;
      --text: #f3f6ff;
      --text-dim: #b8c1d9;
      --border: #252c42;
      --brand: #7aa2ff;
      --brand-soft: #1a2340;
      --card-radius: 14px;
    }
    * { font-family: "Proxima Nova", Inter, "Segoe UI", Roboto, system-ui, -apple-system, Arial, sans-serif; }
    html, body { background: var(--bg); color: var(--text); }

    .page-header {
      background: radial-gradient(1200px 400px at 10% -10%, rgba(122,162,255,.25), transparent),
                  linear-gradient(90deg, var(--brand-soft), rgba(10,14,25,0.6));
      border-bottom: 1px solid var(--border);
    }
    .page-header h2 { font-weight: 700; letter-spacing:.2px; color: var(--text); }
    .muted { color: var(--text-dim); }

    .btn, .btn:focus, .btn:active { box-shadow:none; }
    .btn-outline-secondary { color: var(--text); border-color: var(--border); }
    .btn-outline-secondary:hover { background: var(--card-2); border-color: var(--border); }
    .btn-outline-primary { color: var(--text); border-color: var(--brand); }
    .btn-outline-primary:hover { background: rgba(122,162,255,.12); }

    .section-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--card-radius);
      box-shadow: 0 8px 24px rgba(0,0,0,.25);
      padding: 1rem 1.1rem 1.25rem 1.1rem;
      height: 100%;
      contain: content;
      color: var(--text);
    }
    .section-title { font-weight: 700; font-size: 1.05rem; margin-bottom:.6rem; color: var(--text); }

    /* Executive summary pills */
    .summary-pill {
      border-radius: 999px;
      padding:.7rem 1.1rem;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--border);
      display:inline-flex; gap:.6rem; align-items:center;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      margin:.3rem .6rem .3rem 0;
    }
    .summary-pill .label { color: var(--text-dim); font-size:.9rem; }
    .summary-pill .value { font-weight:700; color: var(--text); font-size:1.05rem; }

    /* DataTables dark theme */
    table.dataTable { table-layout: fixed; color: var(--text); }
    table.table {
      --bs-table-color: var(--text);
      --bs-table-bg: transparent;
      --bs-table-striped-color: var(--text);
      --bs-table-hover-color: var(--text);
      --bs-table-border-color: var(--border);
      --bs-table-striped-bg: rgba(255,255,255,0.06);
      --bs-table-hover-bg: rgba(255,255,255,0.08);
    }
    /* Center headers horizontally + vertically */
    table.dataTable thead th {
      background: var(--card-2) !important;
      border-bottom: 1px solid var(--border) !important;
      color: var(--text) !important;
      text-align: center !important;
      vertical-align: middle !important;
    }
    /* Center body cells horizontally + vertically by default */
    table.dataTable tbody td {
      border-color: var(--border);
      color: var(--text);
      text-align: center;
      vertical-align: middle;
    }
    /* Override DataTables' numeric right-align helpers */
    table.dataTable td.dt-type-numeric,
    table.dataTable th.dt-type-numeric,
    table.dataTable td.dt-right,
    table.dataTable th.dt-right,
    table.dataTable td.dt-body-right,
    table.dataTable th.dt-head-right {
      text-align: center !important;
    }

    /* Inputs */
    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_length label,
    .dataTables_wrapper .dataTables_filter label { color: var(--text-dim); }
    .dataTables_wrapper .dataTables_filter input,
    .dataTables_wrapper .dataTables_length select {
      background: var(--card-2);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
    }
    .dataTables_wrapper .dataTables_filter input::placeholder { color: var(--text-dim); }

    /* Pagination */
    .dataTables_wrapper .dataTables_paginate .paginate_button {
      color: var(--text) !important; border-color: var(--border) !important;
      background: transparent !important;
    }
    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
      background: var(--brand-soft) !important; border-color: var(--border) !important; color: var(--text) !important;
    }

    a, a:visited { color: var(--brand); }
    a:hover { color: #aecdff; }

    /* Long text handling */
    .wrap-text { white-space: pre-wrap; line-height:1.35rem; color: var(--text); }

    /* Actionables block */
    .act {
      display: grid;
      grid-template-columns: 130px 1fr;
      align-items: center;
      column-gap: .8rem;
      background: var(--card-2); border: 1px solid var(--border);
      border-radius: 12px; padding:.65rem .8rem; color: var(--text);
      text-align: left;
    }
    .act .tag {
      justify-self: center;
      font-size:.72rem; font-weight:700; text-transform:uppercase;
      letter-spacing:.04em; color: var(--brand);
      padding:.22rem .55rem; border:1px solid var(--brand); border-radius:999px;
      background: rgba(122,162,255,.08);
    }
    .act .txt { color: var(--text); }

    /* Left-align ONLY the Actionables column */
    td.col-actionables, th.col-actionables {
      text-align: left !important;
      vertical-align: top !important;
    }

    /* PLP combined cell: stack links vertically */
    .plp-links a { display:block; line-height:1.2; margin-bottom:.25rem; }

    .footer-note { color: var(--text-dim); font-size:.85rem; }

    /* Filter dropdown styling */
    .filter-bar {
      margin-bottom: 1rem;
      display: flex;
      gap: 1rem;
      align-items: center;
    }
  </style>
</head>

<body>
  <header class="page-header py-3">
    <div class="container">
      <div class="d-flex flex-wrap align-items-center justify-content-between">
        <div>
          <h2 class="mb-0">Search Assortment — automotive / engine_oil</h2>
          <div class="muted">Category: <strong>automotive</strong> &nbsp;|&nbsp; Subtype: <strong>engine_oil</strong></div>
        </div>
        <div class="text-end">
          <a class="btn btn-outline-secondary btn-sm" href="#" onclick="window.print()">Print</a>
        </div>
      </div>
    </div>
  </header>

  <main class="container my-4">

    <!-- Executive Summary -->
    <div class="section-card mb-4">
      <div class="d-flex align-items-center flex-wrap">
        <div class="summary-pill"><span class="label">Category GMV (AED, L30D)</span><span class="value" id="pill-score">—</span></div>
        <div class="summary-pill"><span class="label">Overall Est. Search Hits (L30D)</span><span class="value" id="pill-hits">—</span></div>
        <div class="summary-pill"><span class="label">Overall Est. GMV Opportunity (AED, L30D) </span><span class="value" id="pill-gmv">—</span></div>
        <div class="muted text-start" style="font-size:0.72em;">Results compare the top 15 products from noon and Amazon. Some brands marked as missing may appear lower 
        on noon but are present in Amazon's top 15. Est. potential GMV is estimated based on ideal search hits share on the keywords (given an ideal assortment), 
        category average conversion and Amazon's average offer price</div>
      </div>
    </div>

    <!-- Keyword level insights -->
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="section-card">
          <div class="section-title">Keyword Insights — Generic</div>
          <table id="tbl-generic" class="table table-striped table-hover w-100"></table>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="section-card">
          <div class="section-title">Keyword Insights — Branded</div>
          <table id="tbl-branded" class="table table-striped table-hover w-100"></table>
        </div>
      </div>
    </div>

    <!-- Detailed analysis -->
    <div class="section-card mt-4">
      <div class="d-flex justify-content-between align-items-center">
        <div class="section-title mb-0">Detailed Analysis</div>
      </div>
      <p class="muted mb-2">Actionables per search term. B1 refers to priority for branded keywords, and G1 for generic</p>
      <table id="tbl-detail" class="table table-striped table-hover w-100"></table>
    </div>

    <div class="my-4 footer-note">
      Data source: <code>noonbigmerchsandbox.satyam.search_assortment_eval_final_draft3</code>. Report for <strong>automotive × engine_oil</strong>. Generated on : <strong>23 Sep 2025, 07:24 PM</strong>
    </div>
  </main>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.datatables.net/v/bs5/dt-2.0.3/b-3.0.1/fh-4.0.1/r-3.0.1/datatables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <script>
    const EXEC_SUMMARY = {"overall_score": 40108.0, "overall_st_hits": 5357, "overall_gmv_oppt": 12577.0};
    const DATA_GENERIC = [{"search_term": "engine oil 5w30", "performance": "Average (0.87)", "st_hits": 1124, "gmv_oppt": 2164.0, "outcome": 1, "express_share": 1.0, "filter_tag": "G1"}, {"search_term": "synthetic car engine oil", "performance": "Below Average (0.84)", "st_hits": 375, "gmv_oppt": 656.0, "outcome": 4, "express_share": 1.0, "filter_tag": "G4"}, {"search_term": "engine oil for turbocharged cars", "performance": "Good (0.91)", "st_hits": 225, "gmv_oppt": 456.0, "outcome": 2, "express_share": 0.53, "filter_tag": "G2"}, {"search_term": "high mileage engine oil", "performance": "Average (0.86)", "st_hits": 150, "gmv_oppt": 603.0, "outcome": 3, "express_share": 1.0, "filter_tag": "G3"}, {"search_term": "car oil", "performance": "Average (0.86)", "st_hits": 75, "gmv_oppt": 144.0, "outcome": 5, "express_share": 1.0, "filter_tag": "G5"}];
    const DATA_BRANDED = [{"search_term": "motul engine oil", "performance": "Good (0.90)", "st_hits": 225, "gmv_oppt": 725.0, "outcome": 9, "express_share": 1.0, "filter_tag": "B9"}, {"search_term": "total engine oil", "performance": "Good (0.93)", "st_hits": 262, "gmv_oppt": 510.0, "outcome": 10, "express_share": 1.0, "filter_tag": "B10"}, {"search_term": "acdelco engine oil", "performance": "Poor (0.70)", "st_hits": 187, "gmv_oppt": 287.0, "outcome": 5, "express_share": 0.21, "filter_tag": "B5"}, {"search_term": "shell engine oil", "performance": "Below Average (0.77)", "st_hits": 637, "gmv_oppt": 1053.0, "outcome": 3, "express_share": 0.8, "filter_tag": "B3"}, {"search_term": "castrol engine oil", "performance": "Below Average (0.84)", "st_hits": 599, "gmv_oppt": 1719.0, "outcome": 6, "express_share": 1.0, "filter_tag": "B6"}, {"search_term": "mobil engine oil", "performance": "Average (0.88)", "st_hits": 524, "gmv_oppt": 1205.0, "outcome": 8, "express_share": 1.0, "filter_tag": "B8"}, {"search_term": "valvoline engine oil", "performance": "Below Average (0.75)", "st_hits": 300, "gmv_oppt": 1584.0, "outcome": 2, "express_share": 1.0, "filter_tag": "B2"}, {"search_term": "adnoc engine oil", "performance": "Excellent (0.95)", "st_hits": 225, "gmv_oppt": 354.0, "outcome": 7, "express_share": 0.33, "filter_tag": "B7"}, {"search_term": "liquimoly engine oil", "performance": "Poor (0.42)", "st_hits": 262, "gmv_oppt": 836.0, "outcome": 1, "express_share": 1.0, "filter_tag": "B1"}, {"search_term": "caltex engine oil", "performance": "Average (0.85)", "st_hits": 187, "gmv_oppt": 282.0, "outcome": 4, "express_share": 0.8, "filter_tag": "B4"}];
    const DATA_DETAIL  = [{"search_term": "motul engine oil", "brand_actionable": "Motul is well represented on both noon and Amazon with 15 and 15 SKUs respectively, all relevant to engine oil in automotive category.", "assortment_actionable": "Noon and Amazon both show diverse Motul engine oil variants (e.g., 5W40, 10W40, 10W50, 0W20) with similar variant depth; noon includes some engine flush and stop leak products.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=motul%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=motul+engine+oil", "outcome": 9, "filter_tag": "B9", "performance_tag": "Good", "express_share": 1.0, "st_hits": 225, "gmv_oppt": 725.0}, {"search_term": "total engine oil", "brand_actionable": "Brand TOTAL is present on both noon and Amazon with 13+ relevant SKUs on noon and similar count on Amazon; products align well with keyword, category, and subcategory.", "assortment_actionable": "Variants cover multiple viscosities and synthetic types on both platforms; noon matches Amazon in core TOTAL Quartz 9000 and 7000 lines with comparable pack sizes and formulations.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=total%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=total+engine+oil", "outcome": 10, "filter_tag": "B10", "performance_tag": "Good", "express_share": 1.0, "st_hits": 262, "gmv_oppt": 510.0}, {"search_term": "acdelco engine oil", "brand_actionable": "ACDelco is present on both noon and Amazon with multiple SKUs relevant to engine oil and related fluids; noon shows strong presence matching the keyword and subcategory.", "assortment_actionable": "Noon offers a variety of ACDelco engine oils and coolants similar to Amazon, though Amazon includes some additional synthetic oil variants; both platforms show relevant product focus.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=acdelco%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=acdelco+engine+oil", "outcome": 5, "filter_tag": "B5", "performance_tag": "Poor", "express_share": 0.21, "st_hits": 187, "gmv_oppt": 287.0}, {"search_term": "shell engine oil", "brand_actionable": "Shell is present on both noon (2 SKUs) and Amazon (15 SKUs) with relevant engine oil products matching the keyword and category/subcategory.", "assortment_actionable": "Shell engine oil variants on noon are fewer and less diverse (2 SKUs) compared to Amazon’s broader range (15 SKUs) including multiple viscosities and pack sizes.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=shell%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=shell+engine+oil", "outcome": 3, "filter_tag": "B3", "performance_tag": "Below Average", "express_share": 0.8, "st_hits": 637, "gmv_oppt": 1053.0}, {"search_term": "castrol engine oil", "brand_actionable": "Castrol is well represented on both noon and Amazon with multiple SKUs strictly relevant to engine oil in automotive category.", "assortment_actionable": "Noon and Amazon both show diverse Castrol engine oil variants (e.g., Magnatec, Edge, GTX) with similar coverage; no major assortment gaps noted.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=castrol%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=castrol+engine+oil", "outcome": 6, "filter_tag": "B6", "performance_tag": "Below Average", "express_share": 1.0, "st_hits": 599, "gmv_oppt": 1719.0}, {"search_term": "mobil engine oil", "brand_actionable": "Mobil is present on both noon and Amazon with strong SKU presence; all products are relevant to engine oil category and subcategory.", "assortment_actionable": "Mobil variants on noon cover synthetic, semi-synthetic, and mineral oils with multiple viscosities; Amazon shows similar range with slight price variation but no major assortment gaps.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=mobil%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=mobil+engine+oil", "outcome": 8, "filter_tag": "B8", "performance_tag": "Average", "express_share": 1.0, "st_hits": 524, "gmv_oppt": 1205.0}, {"search_term": "valvoline engine oil", "brand_actionable": "Valvoline is present on both noon and Amazon with 15+ SKUs each, all relevant to engine oil category and subcategory.", "assortment_actionable": "Noon covers multiple Valvoline engine oil variants (synthetic, all-climate, fleet) but lacks some premium and racing synthetic types present on Amazon.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=valvoline%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=valvoline+engine+oil", "outcome": 2, "filter_tag": "B2", "performance_tag": "Below Average", "express_share": 1.0, "st_hits": 300, "gmv_oppt": 1584.0}, {"search_term": "adnoc engine oil", "brand_actionable": "ADNOC is fully present on both noon and Amazon with 15 and 15 SKUs respectively, all relevant to adnoc engine oil in automotive engine oil subcategory.", "assortment_actionable": "Both platforms show wide ADNOC engine oil variants (5W30, 5W40, 10W40, 20W50, synthetic types); noon matches Amazon in SKU variety and relevance within category and subcategory.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=adnoc%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=adnoc+engine+oil", "outcome": 7, "filter_tag": "B7", "performance_tag": "Excellent", "express_share": 0.33, "st_hits": 225, "gmv_oppt": 354.0}, {"search_term": "liquimoly engine oil", "brand_actionable": "LiquiMoly is present on both noon and Amazon with 4 SKUs on noon and 14 relevant engine oil SKUs on Amazon; noon’s products are less focused on engine oils, including cleaners and additives.", "assortment_actionable": "Noon’s LiquiMoly assortment lacks core engine oil variants compared to Amazon’s broader range of fully synthetic oils, motor oils, and specific grades (e.g., 5W-30, 5W-40, 10W-50).", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=liquimoly%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=liquimoly+engine+oil", "outcome": 1, "filter_tag": "B1", "performance_tag": "Poor", "express_share": 1.0, "st_hits": 262, "gmv_oppt": 836.0}, {"search_term": "caltex engine oil", "brand_actionable": "Caltex is present on both noon and Amazon with multiple SKUs; noon shows 5 relevant Caltex engine oil variants versus Amazon’s broader 15, all fitting the keyword and subcategory.", "assortment_actionable": "Noon offers fewer Caltex engine oil variants (5) compared to Amazon’s wider range (15), with Amazon including more fully synthetic and diesel engine oil options under the brand.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=caltex%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=caltex+engine+oil", "outcome": 4, "filter_tag": "B4", "performance_tag": "Average", "express_share": 0.8, "st_hits": 187, "gmv_oppt": 282.0}, {"search_term": "engine oil 5w30", "brand_actionable": "Brands missing on noon: Shell, Castrol, MANNOL, BMW, Caltex. Common brands: Nissan, TOYOTA, TOTAL, ADNOC, Mobil, LIQUI MOLY.", "assortment_actionable": "Noon shows fewer SKUs from Shell, Castrol, and Caltex with some premium variants missing; Amazon has more consistent relevance and wider variant coverage including 1L and 5L packs.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=engine%20oil%205w30&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=engine+oil+5w30", "outcome": 1, "filter_tag": "G1", "performance_tag": "Average", "express_share": 1.0, "st_hits": 1124, "gmv_oppt": 2164.0}, {"search_term": "synthetic car engine oil", "brand_actionable": "Brands missing on noon: MANNOL, Shell. Common brands: Castrol, Caltex, Motul, Mobil.", "assortment_actionable": "Noon shows fewer Shell variants and lacks MANNOL; assortment includes some pack sizes and variants absent on Amazon; Amazon has more 1L and 4L Shell options.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=synthetic%20car%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=synthetic+car+engine+oil", "outcome": 4, "filter_tag": "G4", "performance_tag": "Below Average", "express_share": 1.0, "st_hits": 375, "gmv_oppt": 656.0}, {"search_term": "engine oil for turbocharged cars", "brand_actionable": "Brands missing on noon: Shell, BMW, Liqui Moly, MANNOL, ACDelco, Total, Castrol, Bar's Leaks. Common brands: DaTo.", "assortment_actionable": "Noon shows strong synthetic engine oil variants but includes some heavy-duty and treatment products; Amazon offers broader brand variety and more specialized turbocharged engine oils.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=engine%20oil%20for%20turbocharged%20cars&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=engine+oil+for+turbocharged+cars", "outcome": 2, "filter_tag": "G2", "performance_tag": "Good", "express_share": 0.53, "st_hits": 225, "gmv_oppt": 456.0}, {"search_term": "high mileage engine oil", "brand_actionable": "Brands missing on noon: Lucas Oil, Castrol, Valvoline, Mobil, STP. Common brands: V8 German Lubricants, Venol.", "assortment_actionable": "Noon shows fewer high mileage engine oil SKUs with limited premium full synthetic options; some oil treatments and power steering products dilute relevance versus Amazon’s focused, broader variant range.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=high%20mileage%20engine%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=high+mileage+engine+oil", "outcome": 3, "filter_tag": "G3", "performance_tag": "Average", "express_share": 1.0, "st_hits": 150, "gmv_oppt": 603.0}, {"search_term": "car oil", "brand_actionable": "Brands missing on noon: Shell, Motul, MANNOL, Infinite Power Plus, Lexus. Common brands: Castrol, Liqui Moly, Mobil.", "assortment_actionable": "Noon shows fewer SKUs from Shell and Castrol Edge variants; Amazon has more premium and diverse synthetic oil options, while noon includes some smaller pack sizes and fewer high-end variants.", "noon_plp_link": "https://www.noon.com/uae-en/search/?q=car%20oil&av=0&e[search-ae]=google", "amazon_plp_link": "https://www.amazon.ae/s?k=car+oil", "outcome": 5, "filter_tag": "G5", "performance_tag": "Average", "express_share": 1.0, "st_hits": 75, "gmv_oppt": 144.0}];

    const clean_text = (text) => text.replace(/ /g, '_')

    const linkToDetail = (term) => `<a class="kw-link" href=#${term.replace(/ /g, '_')}>${term}</a>`;

    const toNumber = (v) => {
      if (v === null || v === undefined) return NaN;
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const s = v.replace(/,/g, '').trim();
        return s === '' ? NaN : Number(s);
      }
      return NaN;
    };
    const fmtInt = (v) => Number.isFinite(toNumber(v)) ? toNumber(v).toLocaleString() : "—";
    const fmtNum = (v) =>
      Number.isFinite(toNumber(v))
        ? toNumber(v).toLocaleString(undefined, { minimumFractionDigits:0, maximumFractionDigits:2 })
        : "—";

    const toLink = (url, label) => {
      if (!url || typeof url !== 'string') return '';
      const safe = url.startsWith('http') ? url : null;
      return safe ? `<a href="${safe}" target="_blank" rel="noopener">${label || 'Open'}</a>` : '';
    };
    const escapeHTML = (s) =>
      String(s ?? '').replace(/[&<>"']/g, (m) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);

    // Build single "Actionables" cell (no Show more / no clamping)
    const makeActionablesCell = (row) => {
      const items = [];
      if (row.assortment_actionable) items.push(`<div class="act"><div class="tag">Assortment</div><div class="txt wrap-text">${escapeHTML(row.assortment_actionable)}</div></div>`);
      if (row.brand_actionable) items.push(`<div class="act"><div class="tag">Brand</div><div class="txt wrap-text">${escapeHTML(row.brand_actionable)}</div></div>`);
      const content = items.join('');
      return `<div class="cell-stack"><div class="wrap-text">${content}</div></div>`;
    };

    // Helper: pick GMV opportunity from available keys (gmv_oppt preferred)
    const pickGmvOppt = (row) => {
      const v = row.gmv_oppt ?? row.gmv_loss ?? row.gmv_opportunity ?? null;
      return v;
    };

    // Helper: get keyword type from outcome/priority
    function getKeywordType(outcome) {
      if (typeof outcome !== "string") return "";
      if (/^B\d+$/i.test(outcome.trim())) return "B";
      if (/^G\d+$/i.test(outcome.trim())) return "G";
      return "";
    }

    // Custom natural sort for filter_tag (e.g., G1, G2, ..., G10, B1, B2, ...)
    function filterTagNaturalSort(a, b) {
      // a and b are the cell values (e.g., "G1", "G10", "B2", etc.)
      // Handle null/undefined/empty
      a = (a || '').toUpperCase();
      b = (b || '').toUpperCase();
      // Extract letter prefix and number
      const re = /^([A-Z]+)(\d+)$/i;
      const ma = a.match(re);
      const mb = b.match(re);
      if (ma && mb) {
        // Compare prefix first
        if (ma[1] < mb[1]) return -1;
        if (ma[1] > mb[1]) return 1;
        // Compare number as integer
        const na = parseInt(ma[2], 10);
        const nb = parseInt(mb[2], 10);
        return na - nb;
      }
      // If only one matches, put matching one first
      if (ma) return -1;
      if (mb) return 1;
      // Fallback to string compare
      return a.localeCompare(b);
    }

    // Register the custom sort with DataTables
    if (window.jQuery && $.fn.dataTable) {
      // Ascending
      $.fn.dataTable.ext.type.order['filter-tag-nat-asc'] = function(a, b) {
        return filterTagNaturalSort(a, b);
      };
      // Descending
      $.fn.dataTable.ext.type.order['filter-tag-nat-desc'] = function(a, b) {
        return filterTagNaturalSort(b, a);
      };
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('pill-score').textContent = fmtInt(EXEC_SUMMARY.overall_score ?? 0);
      document.getElementById('pill-hits').textContent  = fmtInt(EXEC_SUMMARY.overall_st_hits);
      document.getElementById('pill-gmv').textContent   = fmtNum(EXEC_SUMMARY.overall_gmv_oppt);

      // Generic table (center columns)
      $('#tbl-generic').DataTable({
        data: DATA_GENERIC,
        columns: [
          { title:'Search Term',     data:'search_term', className:'text-center align-middle', render:(d)=>linkToDetail(d)},
          { 
            title:'Priority',        
            data:'filter_tag',       
            className:'text-center align-middle', 
            render:(d)=>escapeHTML(d ?? '—'),
            type: 'filter-tag-nat' // Use our custom natural sort
          },
          { title:'Est. Hits',     data:'st_hits',     className:'text-center align-middle', render:(d)=>fmtInt(d) },
          { title:'Est. GMV Potential', data:'gmv_oppt',      className:'text-center align-middle', render:(d)=>fmtNum(d) },
          { title:'Express share', data:'express_share', className:'text-center align-middle', render:(d)=>
            Number.isFinite(toNumber(d))
              ? (toNumber(d)*100).toLocaleString(undefined, undefined) + '%'
              : "—"
          }
        ],
        order: [[1,'asc']], responsive: true, fixedHeader: false, deferRender: true, autoWidth: false,
        pageLength: 10, lengthMenu: [10,25,50,100], dom:'Bfrtip', buttons:['pageLength','copy','csv']
      });

      // Branded table (center columns)
      $('#tbl-branded').DataTable({
        data: DATA_BRANDED,
        columns: [
          { title:'Search Term',     data:'search_term', className:'text-center align-middle', render:(d)=>linkToDetail(d) },
          { 
            title:'Priority',        
            data:'filter_tag',       
            className:'text-center align-middle', 
            render:(d)=>escapeHTML(d ?? '—'),
            type: 'filter-tag-nat' // Use our custom natural sort
          },
          { title:'Est. Hits',     data:'st_hits',     className:'text-center align-middle', render:(d)=>fmtInt(d) },
          { title:'Est. GMV Potential', data:'gmv_oppt',      className:'text-center align-middle', render:(d)=>fmtNum(d) },
          { title:'Express share', data:'express_share', className:'text-center align-middle', render:(d)=>
            Number.isFinite(toNumber(d))
              ? (toNumber(d)*100).toLocaleString(undefined, undefined) + '%'
              : "—"
          }
        ],
        order: [[1,'asc']], responsive: true, fixedHeader: false, deferRender: true, autoWidth: false,
        pageLength: 10, lengthMenu: [10,25,50,100], dom:'Bfrtip', buttons:['pageLength','copy','csv']
      });

      // Detailed Analysis (center everything except Actionables)
      const dtDetail = $('#tbl-detail').DataTable({
        data: DATA_DETAIL,
        columns: [
          { title:'Search Term',     data:'search_term',   width:'10%', className:'text-center align-middle' },
          { 
            title:'Priority',        
            data:'filter_tag',       
            width:'8%', 
            className:'text-center align-middle', 
            render:(d)=>escapeHTML(d ?? '—'),
            type: 'filter-tag-nat' // Use our custom natural sort
          },
          { title:'Insights',        data:null,            width:'44%', className:'col-actionables', render:(d,t,row)=>makeActionablesCell(row) },
          { title:'Est. Hits',       data:'st_hits',       width:'8%', className:'text-center align-middle', render:(d)=>fmtInt(d) },
          { title:'Est. GMV Potential', data:null,          width:'10%', className:'text-center align-middle', render:(d,t,row)=>fmtNum(pickGmvOppt(row)) },
          { title:'Express share',   data:'express_share', className:'text-center align-middle', render:(d)=>
            Number.isFinite(toNumber(d))
              ? (toNumber(d)*100).toLocaleString(undefined, undefined) + '%'
              : "—"
          },
          { title:'PLP',             data:null,            width:'10%', className:'text-center align-middle',
          render:(d,t,row)=>{const parts = [];
            if (row.noon_plp_link)   parts.push(toLink(row.noon_plp_link,   'noon search results'));
            if (row.amazon_plp_link) parts.push(toLink(row.amazon_plp_link, 'Amazon search results'));
            return parts.length ? '<div class="plp-links">' + parts.join('') + '</div>' : '—';
          }
          }
        ],
        order: [[1,'asc']], responsive: false, fixedHeader: false, deferRender: true, autoWidth: false,
        pageLength: 15, lengthMenu: [15,25,50,100], dom:'Bfrtip', buttons:['pageLength','copy','csv'],
        rowId: (d) => d.search_term.replace(/ /g, '_')
      });
    });
  </script>
</body>
</html>
